#!/usr/bin/env ruby
# coding: utf-8
# frozen_string_literal: true

require 'rake'
require 'optparse'
require 'r18n-core'
require 'neruda/config'
require 'neruda/version'

R18n.set(Neruda::Config.settings['lang'] || 'en',
         File.expand_path('../../locales', __FILE__))

# Pablo commands
module PabloCommands
  def pablo_init
    init_config
    init_rakefile
    @rake.run('org:install')
  end
  alias :pablo_install :pablo_init

  def pablo_build(file = ARGV)
    if file.nil?
      @rake.run('site:build')
    else
      @rake.run(ARGV.unshift('-B'))
    end
  end

  def pablo_preview
    @rake.run('site:preview')
  end

  private

  def init_config
    config = Neruda::Config.settings.merge
    changed = false
    if config['author'].nil? || config['author'] == ''
      puts R18n.t.pablo.set_author_name
      author = STDIN.gets.strip
      if author != ''
        config['author'] = author
        changed = true
      end
    end
    if config['lang'].nil? || config['lang'] == ''
      puts "Main language of your website [en]: "
      lang = STDIN.gets.strip
      lang = 'en' if lang == ''
      config['lang'] = lang
      changed = true
    end
    if changed
      Neruda::Config.save(config)
    else
      warn 'Already configured'
    end
  end

  def init_rakefile
    return if File.exist? 'Rakefile'
    rakefile = <<~RAKE
      # frozen_string_literal: true

      require 'neruda/config'
      require 'r18n-core'

      neruda_spec = Gem::Specification.find_by_name 'neruda'
      R18n.set(Neruda::Config.settings['lang'] || 'en',
               "\#{neruda_spec.gem_dir}/locales")

      Dir.glob("\#{neruda_spec.gem_dir}/lib/tasks/*.rake").each { |r| import r }

      task default: 'site:build'
    RAKE
    File.open('Rakefile', 'w') do |f|
      f.puts rakefile
    end
  end
end

# Main pablo class
class Pablo
  def initialize
    @options = {
      verbose: false
    }
    cmd = parse_options
    # Be sure required directories are always there
    init_path
    init_rake
    send cmd
  end

  include PabloCommands

  private

  def init_path
    public_path = Neruda::Config.settings['public_folder'] || 'public_html'
    FileUtils.mkdir_p "#{public_path}/assets"
    local_blog_path = Neruda::Config.settings['blog_slug'] || 'blog'
    FileUtils.mkdir_p "src/#{local_blog_path}"
  end

  def init_rake
    @rake = Rake.application
    Rake.verbose(false) unless @options[:verbose]
  end

  def check_command
    cmd = ARGV[0]
    if cmd == 'new'
      cmd = 'edit'
    elsif cmd == 'install'
      cmd = 'init'
    end
    if !File.exist?('config.yml') && cmd != 'init'
      warn 'ERROR: please run pablo init before all'
      exit 1
    end
    cmd = "pablo_#{cmd}".to_sym
    return nil unless respond_to?(cmd)
    ARGV.shift
    cmd
  end

  def parse_options
    optparse = OptionParser.new do |opts|
      opts.banner = <<~HELP
        Usage: pablo [-v] <command>
               pablo -h

      HELP
      opts.version = Neruda::VERSION
      opts.program_name = 'pablo (Neruda gem)'
      opts.on('-v', '--verbose', 'Output more information') do
        @options[:verbose] = true
      end
      opts.on_tail('-h', '--help', 'Display this screen') do
        pablo_help(opts)
      end
      opts.on_tail('-V', '--version', 'Show version') do
        puts opts.ver
        exit
      end
    end
    optparse.parse!

    command = check_command
    return command unless command.nil?
    warn R18n.t.pablo.error.no_command
    pablo_help(optparse)
    exit 1
  end

  def pablo_help(banner)
    warn banner
    warn <<~HELP

      System Commands
          init         Initialize your Neruda instance
                       (you just need to do it once).
    HELP
    exit
  end
end

Pablo.new
